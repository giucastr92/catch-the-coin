<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Catch the Coin — Reown WalletConnect Demo</title>
    <style>
      :root { --bg:#0b0f1a; --panel:#121827; --text:#e7e9ee; --muted:#8a93a6; --accent:#4f8cff; }
      *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,Segoe UI,Roboto,Arial}
      header{padding:16px 20px;display:flex;gap:12px;align-items:center;justify-content:space-between;background:linear-gradient(180deg,rgba(255,255,255,.04),transparent)}
      h1{margin:0;font-size:18px;font-weight:600}
      .wrap{max-width:920px;margin:0 auto;padding:18px}
      .grid{display:grid;grid-template-columns:1fr 340px;gap:18px}
      canvas{width:100%;aspect-ratio:16/9;background:#0a1020;border:1px solid #1c2440;border-radius:12px;display:block}
      .panel{background:var(--panel);border:1px solid #1c2440;border-radius:12px;padding:14px}
      .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:10px 0}
      button,.btn{appearance:none;border:1px solid #2a355a;background:#111a33;color:var(--text);border-radius:10px;padding:10px 14px;cursor:pointer}
      button:disabled{opacity:.6;cursor:not-allowed}
      small{color:var(--muted)}
      .stat{display:inline-block;background:#0d1530;border:1px solid #1c2440;border-radius:8px;padding:6px 10px;margin-right:8px}
      a{color:var(--accent);text-decoration:none}
      footer{color:var(--muted);padding:16px 20px;text-align:center}
      .ok{color:#64d98a}.warn{color:#ffcc66}.err{color:#ff6b6b}
    </style>
  </head>
  <body>
    <header>
      <h1>Catch the Coin <small style="font-weight:400;color:#8a93a6">• WalletConnect (Reown) demo</small></h1>
      <!-- Pulsanti nativi AppKit (web components) -->
      <div class="row">
        <appkit-network-button></appkit-network-button>
        <appkit-button></appkit-button>
      </div>
    </header>

    <div class="wrap">
      <div class="grid">
        <div>
          <canvas id="game" width="960" height="540"></canvas>
          <div class="row">
            <button id="startBtn">Start</button>
            <button id="submitBtn" disabled>Submit score</button>
            <span id="status" class="stat">Status: <span class="warn">disconnected</span></span>
            <span class="stat">Score: <strong id="score">0</strong></span>
          </div>
          <small>Comandi: frecce direzionali per muovere il giocatore.</small>
        </div>
        <div class="panel">
          <h3 style="margin-top:0">Istruzioni</h3>
          <ol>
            <li>Premi <strong>Connect</strong> per collegare il tuo wallet (WalletConnect / Reown).</li>
            <li>Premi <strong>Start</strong> → ti verrà richiesto di <em>firmare</em> un messaggio.</li>
            <li>Raccogli le monete! Al termine, premi <strong>Submit score</strong> per firmare il punteggio.</li>
          </ol>
          <p><small>Questa demo usa <em>Reown AppKit</em> + <em>Wagmi</em> via CDN (ESM). Sostituisci <code>YOUR_PROJECT_ID</code> con il tuo ID della <a href="https://dashboard.reown.com" target="_blank" rel="noreferrer">Reown Dashboard</a>.</small></p>
          <p><small>Docs AppKit: <a href="https://docs.reown.com/appkit/javascript/core/installation" target="_blank" rel="noreferrer">Installazione & esempi</a>.</small></p>
        </div>
      </div>
    </div>

    <footer>
      Demo ispirata alle guide ufficiali Reown/AppKit. ©
    </footer>

    <!-- Script del gioco + Reown AppKit -->
    <script type="module">
      // --- Import ESM da CDN (jsDelivr) ---
      // AppKit (modal) + adapter Wagmi + reti EVM
      import { createAppKit } from 'https://cdn.jsdelivr.net/npm/@reown/appkit/+esm'
      import { WagmiAdapter } from 'https://cdn.jsdelivr.net/npm/@reown/appkit-adapter-wagmi/+esm'
      import { mainnet, polygon } from 'https://cdn.jsdelivr.net/npm/@reown/appkit/networks/+esm'
      // Azioni wagmi per firma e stato account
      import { getAccount, signMessage } from 'https://cdn.jsdelivr.net/npm/@wagmi/core/+esm'

      // --- CONFIG REOWN / APPKIT ---
      const projectId = '143d475e-39c3-4bff-9c22-4d34a8db3ba1' // <<<< Sostituisci con il tuo ID dalla dashboard Reown
      const networks = [mainnet, polygon]

      // Adapter Wagmi (AppKit si occuperà dei connettori: Injected, WalletConnect, Coinbase, ecc.)
      const wagmiAdapter = new WagmiAdapter({ projectId, networks })

      // Metadati del tuo dapp (il dominio deve combaciare con la tua origine reale in produzione)
      const metadata = {
        name: 'Catch the Coin Demo',
        description: 'Mini gioco con login via WalletConnect (Reown).',
        url: window.location.origin,
        icons: ['https://avatars.githubusercontent.com/u/179229932'] // icona Reown (pubblica)
      }

      // Crea la modal AppKit (mostra <appkit-button> e <appkit-network-button>)
      const modal = createAppKit({
        adapters: [wagmiAdapter],
        networks,
        projectId,
        metadata,
        features: { analytics: true }
      })

      // Espone wagmiConfig dentro l'adapter per le azioni wagmi (@wagmi/core)
      const wagmiConfig = wagmiAdapter.wagmiConfig

      // --- UI elements ---
      const statusEl = document.getElementById('status')
      const scoreEl  = document.getElementById('score')
      const startBtn = document.getElementById('startBtn')
      const submitBtn= document.getElementById('submitBtn')

      function setStatus(text, cls='') {
        statusEl.innerHTML = 'Status: ' + `<span class="${cls}">${text}</span>`
      }

      // Aggiorna lo stato connessione quando apri/chiudi la modal
      function refreshConnectionState() {
        const account = getAccount(wagmiConfig)
        if (account?.status === 'connected') {
          setStatus('connected', 'ok')
          submitBtn.disabled = false
        } else if (account?.status === 'reconnecting') {
          setStatus('reconnecting…', 'warn')
          submitBtn.disabled = true
        } else {
          setStatus('disconnected', 'warn')
          submitBtn.disabled = true
        }
      }

      // Prova a ricollegare sessioni esistenti
      refreshConnectionState()

      // --- Gioco: Catch the Coin ---
      const canvas = document.getElementById('game')
      const ctx = canvas.getContext('2d')
      const W = canvas.width, H = canvas.height

      const player = { x: 60, y: H/2, s: 24, speed: 4 }
      const coin   = { x: 400, y: 300, r: 12 }
      let keys = {ArrowUp:false, ArrowDown:false, ArrowLeft:false, ArrowRight:false}
      let score = 0
      let running = false
      let raf

      function rand(min, max){ return Math.floor(Math.random()*(max-min+1))+min }
      function resetCoin(){
        coin.x = rand(40, W-40)
        coin.y = rand(40, H-40)
      }
      function draw(){
        ctx.clearRect(0,0,W,H)
        // background grid
        ctx.globalAlpha = 1
        ctx.fillStyle = '#0b122b'
        ctx.fillRect(0,0,W,H)
        ctx.globalAlpha = 0.2
        ctx.strokeStyle = '#2a355a'
        for(let x=0;x<W;x+=40){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke() }
        for(let y=0;y<H;y+=40){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke() }
        ctx.globalAlpha = 1

        // coin
        ctx.beginPath()
        ctx.fillStyle = '#ffd54a'
        ctx.arc(coin.x, coin.y, coin.r, 0, Math.PI*2)
        ctx.fill()
        ctx.fillStyle = '#caa128'
        ctx.font = '16px system-ui'
        ctx.fillText('₿', coin.x-5, coin.y+6)

        // player
        ctx.fillStyle = '#4f8cff'
        ctx.fillRect(player.x - player.s/2, player.y - player.s/2, player.s, player.s)

        // hud
        ctx.fillStyle = 'white'
        ctx.font = '18px system-ui'
        ctx.fillText('Score: '+score, 16, 26)
      }

      function update(){
        if (keys.ArrowUp)    player.y -= player.speed
        if (keys.ArrowDown)  player.y += player.speed
        if (keys.ArrowLeft)  player.x -= player.speed
        if (keys.ArrowRight) player.x += player.speed
        // bounds
        player.x = Math.max(player.s/2, Math.min(W - player.s/2, player.x))
        player.y = Math.max(player.s/2, Math.min(H - player.s/2, player.y))
        // collision
        const dx = player.x - coin.x, dy = player.y - coin.y
        if (Math.hypot(dx, dy) < player.s/2 + coin.r) {
          score += 1
          scoreEl.textContent = String(score)
          resetCoin()
        }
      }

      function loop(){
        if (!running) return
        update()
        draw()
        raf = requestAnimationFrame(loop)
      }

      window.addEventListener('keydown', e => { if(keys.hasOwnProperty(e.key)) keys[e.key]=true })
      window.addEventListener('keyup',   e => { if(keys.hasOwnProperty(e.key)) keys[e.key]=false })

      // --- Logica “Start”: richiede firma per avviare il gioco ---
      startBtn.addEventListener('click', async () => {
        try {
          const account = getAccount(wagmiConfig)
          if (account.status !== 'connected') {
            // Apri la modal di connessione
            modal.open()
            return
          }
          // Firma messaggio di avvio (SIWE-like semplice — solo dimostrazione)
          const msg = `Start game\nAddress: ${account.address}\nTs: ${Date.now()}`
          await signMessage(wagmiConfig, { message: msg })
          // Avvia gioco
          score = 0
          scoreEl.textContent = '0'
          running = true
          cancelAnimationFrame(raf)
          resetCoin()
          loop()
          setStatus('playing (connected)', 'ok')
        } catch (err) {
          console.error(err)
          setStatus('signature rejected', 'err')
        }
      })

      // Submit score: firma il punteggio (dimostrativo — nessun backend)
      submitBtn.addEventListener('click', async () => {
        try {
          const account = getAccount(wagmiConfig)
          if (account.status !== 'connected') { setStatus('disconnected', 'warn'); return }
          const payload = `Submit score\nAddress: ${account.address}\nScore: ${score}\nTs: ${Date.now()}`
          await signMessage(wagmiConfig, { message: payload })
          setStatus('score signed ✔', 'ok')
        } catch (err) {
          console.error(err)
          setStatus('submit canceled', 'warn')
        }
      })

      // Aggiorna lo stato al ritorno dalla modal
      window.addEventListener('focus', refreshConnectionState)
    </script>
  </body>
</html>
